name: Deploy to Dokku

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: backend
            dir: backend
            app_var: DOKKU_BACKEND_APP
            port: 1337
            exclude: "--exclude='node_modules' --exclude='.git' --exclude='*.log' --exclude='.cache' --exclude='.tmp' --exclude='.strapi-updater.json'"
          - service: frontend
            dir: frontend
            app_var: DOKKU_FRONTEND_APP
            port: 3000
            exclude: "--exclude='node_modules' --exclude='.git' --exclude='*.log' --exclude='.next'"
    steps:
      - uses: actions/checkout@v5

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Add Dokku host to known hosts
        run: ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts

      - name: Configure port mapping
        run: |
          ssh dokku@${{ vars.DOKKU_HOST }} ports:list ${{ vars[matrix.app_var] }} > /dev/null 2>&1 || \
          ssh dokku@${{ vars.DOKKU_HOST }} ports:add ${{ vars[matrix.app_var] }} http:80:${{ matrix.port }}

      - name: Create and deploy tar archive
        run: |
          cd ${{ matrix.dir }}
          tar -czf ../${{ matrix.service }}.tar.gz ${{ matrix.exclude }} . 2>/dev/null || \
          tar -czf ../${{ matrix.service }}.tar.gz --exclude='node_modules' --exclude='.git' .
          cd ..
          cat ${{ matrix.service }}.tar.gz | ssh dokku@${{ vars.DOKKU_HOST }} git:from-archive ${{ vars[matrix.app_var] }} --
          echo "âœ… ${{ matrix.service }} deployment completed"

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Check status
        run: |
          ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts
          echo "ğŸ” Checking services..."
          ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ vars.DOKKU_BACKEND_APP }} | grep "Status"
          ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ vars.DOKKU_FRONTEND_APP }} | grep "Status"
          echo "âœ… Deployment completed!"
          echo "ğŸŒ Backend:  https://${{ vars.BACKEND_DOMAIN }}"
          echo "ğŸŒ Frontend: https://${{ vars.FRONTEND_DOMAIN }}"
