name: Deploy to Dokku

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: backend
            dir: backend
            app_var: DOKKU_BACKEND_APP
            port: 1337
            exclude: "--exclude='node_modules' --exclude='.git' --exclude='*.log' --exclude='.cache' --exclude='.tmp' --exclude='.strapi-updater.json'"
          - service: frontend
            dir: frontend
            app_var: DOKKU_FRONTEND_APP
            port: 3000
            exclude: "--exclude='node_modules' --exclude='.git' --exclude='*.log' --exclude='.next'"
    steps:
      - uses: actions/checkout@v5

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Add Dokku host to known hosts
        run: ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts

      - name: Configure port mapping
        run: |
          ssh dokku@${{ vars.DOKKU_HOST }} ports:list ${{ vars[matrix.app_var] }} > /dev/null 2>&1 || \
          ssh dokku@${{ vars.DOKKU_HOST }} ports:add ${{ vars[matrix.app_var] }} http:80:${{ matrix.port }}

      - name: Create and deploy tar archive
        shell: bash
        run: |
          set +e  # Don't exit on error, we'll handle errors manually

          cd ${{ matrix.dir }}
          tar -czf ../${{ matrix.service }}.tar.gz ${{ matrix.exclude }} . 2>/dev/null || \
          tar -czf ../${{ matrix.service }}.tar.gz --exclude='node_modules' --exclude='.git' .
          cd ..

          # Deploy and capture output
          echo "ğŸš€ Deploying ${{ matrix.service }}..."
          OUTPUT=$(cat ${{ matrix.service }}.tar.gz | ssh dokku@${{ vars.DOKKU_HOST }} git:from-archive ${{ vars[matrix.app_var] }} -- 2>&1) || true
          echo "$OUTPUT"

          # Check if no changes detected and rebuild if necessary
          if echo "$OUTPUT" | grep -q "No changes detected"; then
            echo "âš ï¸  No changes detected, triggering rebuild..."
            ssh dokku@${{ vars.DOKKU_HOST }} ps:rebuild ${{ vars[matrix.app_var] }}
            if [ $? -eq 0 ]; then
              echo "âœ… ${{ matrix.service }} rebuild completed"
              exit 0
            else
              echo "âŒ ${{ matrix.service }} rebuild failed"
              exit 1
            fi
          elif echo "$OUTPUT" | grep -q "Application deployed"; then
            echo "âœ… ${{ matrix.service }} deployment completed"
            exit 0
          else
            echo "âš ï¸  Unexpected output, checking if deployment succeeded..."
            # Check if app is running
            if ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ vars[matrix.app_var] }} | grep -q "running"; then
              echo "âœ… ${{ matrix.service }} is running"
              exit 0
            else
              echo "âŒ ${{ matrix.service }} deployment may have failed"
              exit 1
            fi
          fi

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Check status
        run: |
          ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts
          echo "ğŸ” Checking services..."
          ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ vars.DOKKU_BACKEND_APP }} | grep "Status"
          ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ vars.DOKKU_FRONTEND_APP }} | grep "Status"
          echo "âœ… Deployment completed!"
          echo "ğŸŒ Backend:  https://${{ vars.BACKEND_DOMAIN }}"
          echo "ğŸŒ Frontend: https://${{ vars.FRONTEND_DOMAIN }}"
