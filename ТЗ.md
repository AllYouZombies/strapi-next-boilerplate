# ТЗ: Boilerplate проект Strapi + Next.js с Docker

## Цель
Создать готовый к использованию boilerplate проект с Strapi CMS (backend) и Next.js (frontend), который запускается одной командой `docker compose up -d`.

## Структура проекта

```
project-root/
├── frontend/
│   ├── Dockerfile
│   ├── .dockerignore
│   ├── package.json
│   ├── next.config.js
│   ├── app/
│   │   ├── layout.tsx
│   │   └── page.tsx
│   └── ... (стандартная структура Next.js App Router)
│
├── backend/
│   ├── Dockerfile
│   ├── .dockerignore
│   ├── package.json
│   ├── config/
│   │   ├── database.js
│   │   ├── server.js
│   │   └── admin.js
│   └── ... (стандартная структура Strapi)
│
├── docker-compose.yml
├── .env
├── .env.example
├── .gitignore
└── README.md
```

## Технические требования

### Backend (Strapi)
- **Версия**: Strapi 5.30.1 (последняя стабильная на ноябрь 2025)
- **Database**: PostgreSQL 18
- **Node.js**: 24-alpine (LTS Krypton)
- **Порт**: 1337
- **Конфигурация**:
  - Подключение к PostgreSQL через переменные окружения
  - Admin panel доступен по `/admin`
  - API доступно по `/api`
  - CORS настроен для frontend (http://localhost:3000)

### Frontend (Next.js)
- **Версия**: Next.js 15.5 (последняя стабильная на ноябрь 2025)
- **Node.js**: 24-alpine (LTS Krypton)
- **Порт**: 3000
- **Конфигурация**:
  - App Router (не Pages Router)
  - TypeScript
  - Базовая интеграция с Strapi API через переменную `NEXT_PUBLIC_STRAPI_URL`
  - Пример fetch запроса к Strapi на главной странице

### Database (PostgreSQL)
- **Версия**: PostgreSQL 18-alpine
- **Порт**: 5432 (только для docker network, не expose наружу)
- **Persistent volume**: для сохранения данных между перезапусками

## Dockerfile требования

**ВАЖНО**: Каждый Dockerfile должен иметь отдельные target для development и production:
- `target: development` - для локальной разработки с hot-reload
- `target: production` (default) - для production билдов

### Backend Dockerfile (Strapi)

Базируется на официальной документации Strapi: https://docs.strapi.io/cms/installation/docker

```dockerfile
# Multi-stage build с отдельными target

# Stage 1: base - общая база
FROM node:24-alpine AS base
RUN apk update && apk add --no-cache build-base gcc autoconf automake zlib-dev libpng-dev vips-dev git > /dev/null 2>&1
WORKDIR /opt/app

# Stage 2: dependencies - установка зависимостей
FROM base AS dependencies
COPY package.json package-lock.json ./
RUN npm ci --only=production && npm cache clean --force
COPY package.json package-lock.json ./
RUN npm ci --only=development && npm cache clean --force

# Stage 3: development - для локальной разработки
FROM base AS development
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
ENV NODE_ENV=development
EXPOSE 1337
CMD ["npm", "run", "develop"]

# Stage 4: builder - сборка для production
FROM base AS builder
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
ENV NODE_ENV=production
RUN npm run build

# Stage 5: production (default) - финальный production образ
FROM base AS production
COPY --from=dependencies /opt/app/node_modules ./node_modules
COPY --from=builder /opt/app/dist ./dist
COPY --from=builder /opt/app/build ./build
COPY --from=builder /opt/app/public ./public
COPY --from=builder /opt/app/package.json ./package.json
COPY --from=builder /opt/app/node_modules/.cache/strapi-plugin-content-manager ./node_modules/.cache/strapi-plugin-content-manager

# Создать non-root user для безопасности
RUN addgroup -g 1001 -S nodejs && adduser -S strapi -u 1001
RUN chown -R strapi:nodejs /opt/app
USER strapi

ENV NODE_ENV=production
EXPOSE 1337
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
  CMD node -e "require('http').get('http://localhost:1337/_health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
CMD ["npm", "run", "start"]
```

### Frontend Dockerfile (Next.js)

Базируется на официальном примере Next.js: https://github.com/vercel/next.js/tree/canary/examples/with-docker

```dockerfile
# Multi-stage build с отдельными target

# Stage 1: base - общая база
FROM node:24-alpine AS base
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Stage 2: deps - установка production зависимостей
FROM base AS deps
COPY package.json package-lock.json* ./
RUN npm ci

# Stage 3: development - для локальной разработки с hot-reload
FROM base AS development
COPY package.json package-lock.json* ./
RUN npm ci
COPY . .
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1
EXPOSE 3000
CMD ["npm", "run", "dev"]

# Stage 4: builder - сборка для production
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Включить standalone output для оптимального размера образа
# next.config.js должен содержать: output: 'standalone'
ENV NEXT_TELEMETRY_DISABLED=1
RUN npm run build

# Stage 5: production (default) - финальный production образ
FROM base AS production
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Создать non-root user для безопасности
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Копировать public assets
COPY --from=builder /app/public ./public

# Копировать standalone output и static files
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["node", "server.js"]
```

## docker-compose.yml требования

**ВАЖНО**: compose.yml используется только для локальной разработки с hot-reload. Production образы собираются через `docker build` без compose.

### Пример структуры:
```yaml
services:
  postgres:
    image: postgres:18-alpine
    container_name: postgres
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development  # ВАЖНО: для hot-reload
    container_name: backend
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./backend:/opt/app
      - /opt/app/node_modules  # prevent overwriting
    ports:
      - "1337:1337"
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development  # ВАЖНО: для hot-reload
    container_name: frontend
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_STRAPI_URL=http://localhost:1337
    volumes:
      - ./frontend:/app
      - /app/node_modules  # prevent overwriting
      - /app/.next  # prevent overwriting
    ports:
      - "3000:3000"
    networks:
      - app-network
    depends_on:
      - backend

volumes:
  postgres-data:

networks:
  app-network:
    driver: bridge
```

### Ключевые моменты:
1. **target: development** - использует development stage из Dockerfile для hot-reload
2. **volumes** - монтируются директории для live-reload изменений
3. **node_modules excluded** - предотвращает перезапись node_modules из контейнера
4. **healthcheck для postgres** - обеспечивает правильный порядок запуска

## Переменные окружения

### .env.example (с комментариями)
```env
# Database
POSTGRES_USER=strapi
POSTGRES_PASSWORD=strapi_password_change_me
POSTGRES_DB=strapi

# Strapi Backend
DATABASE_CLIENT=postgres
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=strapi
DATABASE_USERNAME=strapi
DATABASE_PASSWORD=strapi_password_change_me
DATABASE_SSL=false

# Strapi Security Keys (generate with: openssl rand -base64 32)
APP_KEYS=generate_random_string_here
API_TOKEN_SALT=generate_random_string_here
ADMIN_JWT_SECRET=generate_random_string_here
TRANSFER_TOKEN_SALT=generate_random_string_here
JWT_SECRET=generate_random_string_here

NODE_ENV=development
HOST=0.0.0.0
PORT=1337

# Frontend
NEXT_PUBLIC_STRAPI_URL=http://localhost:1337
```

### .env (с реальными значениями)
- Копия .env.example с сгенерированными секретами
- Добавить в .gitignore

## .dockerignore для обоих сервисов
```
node_modules
.next
.cache
.env
.env.local
.env.*.local
npm-debug.log
yarn-debug.log
yarn-error.log
.git
.gitignore
README.md
dist
build
.tmp
.strapi
```

## README.md требования

Должен содержать:

### 1. Краткое описание проекта
- Что это: Boilerplate для Strapi CMS + Next.js
- Основные технологии

### 2. Системные требования
- Docker 24.0+
- Docker Compose 2.20+

### 3. Локальная разработка (с hot-reload)
```bash
# Копировать и настроить .env
cp .env.example .env
# Отредактировать .env (сгенерировать секреты)

# Запустить все сервисы в development режиме
docker compose up -d

# Посмотреть логи
docker compose logs -f

# Остановить
docker compose down

# Полная очистка (включая volumes)
docker compose down -v
```

### 4. Production сборка (без compose)
```bash
# Сборка backend production образа
cd backend
docker build -t my-strapi:latest .
# По умолчанию собирается production target

# Сборка frontend production образа  
cd frontend
docker build -t my-nextjs:latest .
# По умолчанию собирается production target

# Запуск production образов
docker run -d -p 1337:1337 --env-file .env my-strapi:latest
docker run -d -p 3000:3000 -e NEXT_PUBLIC_STRAPI_URL=http://localhost:1337 my-nextjs:latest
```

### 5. Доступ к сервисам
- Frontend: http://localhost:3000
- Strapi Admin: http://localhost:1337/admin
- Strapi API: http://localhost:1337/api

### 6. Первый запуск Strapi
- При первом заходе на /admin создать admin пользователя
- Настроить permissions для публичного доступа к API (Settings → Users & Permissions Plugin → Roles → Public)

### 7. Структура проекта
```
project-root/
├── frontend/          # Next.js приложение
│   ├── Dockerfile     # Multi-stage: development + production
│   └── ...
├── backend/           # Strapi CMS
│   ├── Dockerfile     # Multi-stage: development + production  
│   └── ...
├── docker-compose.yml # Для локальной разработки (target: development)
├── .env               # Переменные окружения (не коммитить!)
└── .env.example       # Пример переменных окружения
```

### 8. Важные замечания
- **Development**: `docker compose up` использует `target: development` для hot-reload
- **Production**: `docker build` по умолчанию собирает production образ (default target)
- **Секреты**: Всегда генерируйте новые секреты для production с помощью `openssl rand -base64 32`
- **Next.js config**: Убедитесь что `next.config.js` содержит `output: 'standalone'` для production

## Функциональные требования

### Frontend
На главной странице (app/page.tsx) показать:
- Заголовок "Next.js + Strapi Boilerplate"
- Статус подключения к Strapi API (успешно/ошибка)
- Простой fetch к `${NEXT_PUBLIC_STRAPI_URL}/api` для проверки
- Базовый стиль (Tailwind CSS)

**ВАЖНО**: next.config.js должен содержать:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone', // Необходимо для Docker production
};

module.exports = nextConfig;
```

### Backend
- Чистая установка Strapi без кастомных content types
- Все стандартные плагины включены (i18n, users-permissions, upload)
- API публично доступно (можно настроить permissions позже вручную)

## Важные детали

1. **Build targets**: Dockerfile имеет отдельные targets:
   - `development` - для локальной разработки с hot-reload
   - `production` (default) - для production без лишних зависимостей

2. **compose.yml vs docker build**:
   - `docker compose up` → использует `target: development`, монтирует volumes, hot-reload работает
   - `docker build .` → по умолчанию собирает `production` target, минимальный образ

3. **Hot-reload в development**:
   - Frontend: Next.js автоматически обновляется при изменении файлов
   - Backend: Strapi использует `strapi develop` с автоматической перезагрузкой
   - Volumes монтируют код из хоста в контейнер
   - node_modules и .next исключены из volumes чтобы не перезаписывать

4. **Build time optimization**: 
   - Dockerfile оптимизирован для кеширования слоев
   - Dependencies устанавливаются отдельно от кода приложения
   - Production образ использует multi-stage build для минимального размера

5. **Security**: 
   - Не коммитить .env в Git
   - Production образы запускаются от non-root user (nextjs/strapi)
   - Использовать strong secrets в production: `openssl rand -base64 32`

6. **Healthchecks**: 
   - Все сервисы имеют healthcheck для правильного depends_on
   - PostgreSQL проверяется через pg_isready
   - Backend/Frontend через HTTP запросы

7. **Logs**: 
   - Логи видны через `docker compose logs -f [service]`
   - Для production используйте централизованное логирование

8. **Strapi 5 особенности**: 
   - Document Service API вместо Entity Service
   - Новая структура конфигурации
   - Поддержка TypeScript out of the box

## Дополнительные файлы

### .gitignore
```
# Dependencies
node_modules
.pnp
.pnp.js

# Production
/build
dist
.next
out

# Environment
.env
.env*.local

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Strapi
.strapi
.tmp
.cache

# OS
.DS_Store
*.pem

# Docker
docker-compose.override.yml
```

## Критерии приемки

### Локальная разработка (Development)
- [ ] `docker compose up -d` запускает все сервисы без ошибок
- [ ] Frontend доступен на http://localhost:3000
- [ ] Strapi admin доступен на http://localhost:1337/admin
- [ ] Frontend может делать запросы к Strapi API
- [ ] **Hot-reload работает**: изменения в коде frontend/backend автоматически применяются
- [ ] PostgreSQL данные сохраняются между перезапусками (`docker compose down` + `up`)
- [ ] Логи доступны через `docker compose logs -f`

### Production сборка
- [ ] `docker build ./backend` собирает production образ Strapi (target: production по умолчанию)
- [ ] `docker build ./frontend` собирает production образ Next.js (target: production по умолчанию)
- [ ] Production образы работают с минимальными зависимостями (только production deps)
- [ ] Production образы запускаются от non-root user
- [ ] Healthcheck работает в production образах
- [ ] Размер production образа оптимизирован (Next.js ~200-300MB, Strapi ~300-400MB)

### Общее
- [ ] Проект можно склонировать и запустить за 2-3 минуты
- [ ] Все environment variables вынесены в .env
- [ ] Есть .env.example с описанием и примерами всех переменных
- [ ] README содержит инструкции для development и production
- [ ] Используются актуальные версии (Node.js 24 LTS, PostgreSQL 18, Strapi 5.30.x, Next.js 15.5)
- [ ] .dockerignore настроен для исключения ненужных файлов
- [ ] .gitignore правильно настроен (не коммитит .env, node_modules, .next, etc.)

## Constraints

- Использовать только официальные Docker образы
- Минимальный размер итоговых образов (использовать alpine, multi-stage builds)
- Не включать никакие дополнительные зависимости (оставить чистый boilerplate)
- Код должен быть готов к production (но запускаться в dev режиме по умолчанию)
- Совместимость с актуальными версиями всех компонентов

## Версионная матрица совместимости

| Компонент | Версия | Примечания |
|-----------|--------|------------|
| Node.js | 24.x LTS (Krypton) | Поддержка до апреля 2028 |
| PostgreSQL | 18 | Последняя версия (сентябрь 2025) |
| Strapi | 5.30.1 | Последняя стабильная |
| Next.js | 15.5 | С поддержкой React 19 |

---

## Итоговая структура Dockerfile

### Backend Dockerfile - Target структура:
```
base (node:24-alpine + dependencies)
  ├── dependencies (prod + dev node_modules)
  ├── development (для compose.yml, hot-reload)
  ├── builder (сборка production build)
  └── production (default, минимальный образ)
```

### Frontend Dockerfile - Target структура:
```
base (node:24-alpine)
  ├── deps (node_modules)
  ├── development (для compose.yml, hot-reload)
  ├── builder (next build + standalone)
  └── production (default, только standalone output)
```

## Команды для работы с проектом

### Локальная разработка
```bash
# Первый запуск
cp .env.example .env
# Отредактировать .env

# Запуск development окружения
docker compose up -d

# Просмотр логов всех сервисов
docker compose logs -f

# Просмотр логов конкретного сервиса
docker compose logs -f backend
docker compose logs -f frontend

# Перезапуск после изменений в Dockerfile
docker compose up -d --build

# Остановка без удаления volumes
docker compose down

# Полная очистка (удалить volumes с БД)
docker compose down -v

# Вход в контейнер для debugging
docker compose exec backend sh
docker compose exec frontend sh
```

### Production сборка
```bash
# Сборка backend
cd backend
docker build -t myproject/strapi:latest .
docker build -t myproject/strapi:1.0.0 .

# Сборка frontend
cd frontend  
docker build -t myproject/nextjs:latest .
docker build -t myproject/nextjs:1.0.0 .

# Запуск production образов локально (для тестирования)
docker run -d \
  --name strapi-prod \
  -p 1337:1337 \
  --env-file .env \
  myproject/strapi:latest

docker run -d \
  --name nextjs-prod \
  -p 3000:3000 \
  -e NEXT_PUBLIC_STRAPI_URL=http://localhost:1337 \
  myproject/nextjs:latest

# Остановка и удаление
docker stop strapi-prod nextjs-prod
docker rm strapi-prod nextjs-prod
```

### Деплой в Registry
```bash
# Логин в Docker Hub (или другой registry)
docker login

# Push образов
docker push myproject/strapi:latest
docker push myproject/strapi:1.0.0
docker push myproject/nextjs:latest
docker push myproject/nextjs:1.0.0
```

---

