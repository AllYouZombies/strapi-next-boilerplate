# Internationalization (i18n) Guide

## Overview

This project implements full multilingual support with **3 languages**:
- **Russian (ru)** - Default language
- **Uzbek (uz)** - O'zbekcha
- **English (en)**

**Technologies:**
- **Backend**: Strapi 5 i18n plugin
- **Frontend**: next-intl library
- **Routing**: Locale-based URL structure (`/ru/`, `/uz/`, `/en/`)

## URL Structure

All pages are prefixed with the locale:

```
/ru/                 → Russian home page
/uz/                 → Uzbek home page
/en/                 → English home page
/ru/products         → Russian products catalog
/uz/products         → Uzbek products catalog
/ru/products/slug    → Russian product detail
```

## How It Works

### Frontend (Next.js)

1. **Routing**: `middleware.ts` intercepts requests and adds locale prefix
2. **Translations**: UI strings stored in `messages/{locale}.json`
3. **Content**: Fetched from Strapi API with `locale` parameter
4. **Switcher**: LanguageSwitcher component in top-right corner

### Backend (Strapi)

1. **i18n Plugin**: Enabled in `backend/config/plugins.ts`
2. **Localized Content**: Content types marked with `pluginOptions.i18n.localized: true`
3. **API**: Returns content based on `?locale=` query parameter

## Project Structure

```
frontend/
├── i18n.ts                    # i18n configuration
├── middleware.ts              # Locale routing middleware
├── messages/                  # UI translations
│   ├── ru.json               # Russian translations
│   ├── uz.json               # Uzbek translations
│   └── en.json               # English translations
├── app/
│   ├── [locale]/             # Locale-based routes
│   │   ├── layout.tsx        # Localized layout
│   │   └── page.tsx          # Home page
│   └── api/
│       └── revalidate/       # Revalidation endpoint
└── components/
    └── LanguageSwitcher.tsx  # Language switcher UI

backend/
├── config/
│   └── plugins.ts            # i18n plugin config
└── src/api/product/
    └── content-types/product/
        └── schema.json       # Localized content type
```

## Usage Examples

### Server Components (getTranslations)

```typescript
import { getTranslations } from 'next-intl/server';

export default async function Page({ params }) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'home' });

  return <h1>{t('title')}</h1>;
}
```

### Client Components (useTranslations)

```typescript
'use client';
import { useTranslations } from 'next-intl';

export default function Component() {
  const t = useTranslations('common');

  return <button>{t('addToCart')}</button>;
}
```

### Fetching Localized Content from Strapi

```typescript
async function getProducts(locale: string) {
  const res = await fetch(
    `${process.env.STRAPI_URL}/api/products?locale=${locale}&populate=*`,
    { cache: 'force-cache' }
  );
  return res.json();
}
```

### Formatting Utils

```typescript
import { formatPrice, formatDate } from '@/lib/utils';

formatPrice(10000, 'ru');  // "10 000 сум"
formatPrice(10000, 'uz');  // "10 000 so'm"
formatPrice(10000, 'en');  // "10,000 UZS"

formatDate(new Date(), 'ru', 'medium');  // "11 ноября 2025 г."
```

## Adding a New Language

### 1. Update Configuration

**frontend/i18n.ts:**
```typescript
export const locales = ['ru', 'uz', 'en', 'kk'] as const; // Add 'kk'
```

**backend/config/plugins.ts:**
```typescript
locales: ['ru', 'uz', 'en', 'kk'], // Add 'kk'
```

**Environment files:**
```bash
# .env and .env.example
AVAILABLE_LOCALES=ru,uz,en,kk
NEXT_PUBLIC_AVAILABLE_LOCALES=ru,uz,en,kk
```

### 2. Create Translation File

Create `frontend/messages/kk.json`:
```json
{
  "common": {
    "currency": "тг",
    "addToCart": "Себетке қосу"
  },
  "nav": {
    "home": "Басты бет"
  }
}
```

### 3. Update Utils (Optional)

Add currency and date formatting for the new locale in `lib/utils.ts`.

### 4. Update Strapi

1. Go to **Settings** → **Internationalization**
2. Add new locale (e.g., Kazakh - kk)
3. Restart Strapi

### 5. Restart Services

```bash
docker compose restart backend frontend
```

## Adding New Translations

Edit `messages/{locale}.json`:

```json
{
  "products": {
    "title": "Каталог товаров",
    "newKey": "Новый перевод"
  }
}
```

Then use in components:
```typescript
const t = useTranslations('products');
t('newKey'); // "Новый перевод"
```

## SEO & Metadata

### Generate Metadata with Translations

```typescript
export async function generateMetadata({ params }): Promise<Metadata> {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'home' });

  return {
    title: t('metaTitle'),
    description: t('metaDescription'),
    alternates: {
      languages: {
        ru: `https://example.com/ru`,
        uz: `https://example.com/uz`,
        en: `https://example.com/en`,
      },
    },
  };
}
```

This generates proper `<link rel="alternate" hreflang="ru" href="...">` tags for SEO.

## Revalidation

When content is updated in Strapi, the revalidation webhook automatically clears cache for **ALL locales**:

```typescript
// This happens automatically in app/api/revalidate/route.ts
for (const locale of locales) {
  revalidatePath(`/${locale}/products/${slug}`);
}
```

No manual intervention needed!

## Common Patterns

### Get Current Locale

```typescript
// Server Component
async function Page({ params }) {
  const { locale } = await params;
}

// Client Component
import { useLocale } from 'next-intl';
const locale = useLocale();
```

### Programmatic Navigation

```typescript
'use client';
import { useRouter } from 'next/navigation';

const router = useRouter();
router.push(`/${newLocale}/products`);
```

### Link to Other Locale

```tsx
<Link href="/uz/products">Uzbek version</Link>
```

## Best Practices

1. **Always include locale parameter** when fetching from Strapi
2. **Use cache: 'force-cache'** for all Strapi fetch requests
3. **Separate UI translations** (messages/*.json) from **content translations** (Strapi)
4. **Test all locales** after making changes
5. **Use formatting utils** for prices and dates instead of hardcoding
6. **Check revalidation logs** when updating content

## Troubleshooting

### Locale not found (404)

- Check middleware matcher in `middleware.ts`
- Verify locale exists in `i18n.ts`
- Restart development server

### Translations not showing

- Verify key exists in `messages/{locale}.json`
- Check namespace is correct in `useTranslations('namespace')`
- Clear `.next` cache and rebuild

### Strapi returns wrong language

- Ensure `?locale={locale}` parameter is included in API URL
- Check i18n plugin is enabled in Strapi
- Verify content has translations in all locales

### Revalidation not working for all locales

- Check logs: `docker compose logs -f frontend`
- Verify `locales` array is imported in `app/api/revalidate/route.ts`
- Restart frontend service

## Testing

### Test Language Switcher

1. Open http://localhost:3000/ru
2. Click on language switcher (top-right)
3. Switch to UZ or EN
4. Verify URL changes to `/uz` or `/en`
5. Verify UI translations change

### Test Localized Content

1. Create product in Strapi admin (Russian)
2. Add translations (Uzbek, English)
3. View product on frontend in each language
4. Verify correct content displays

### Test Revalidation

1. Edit product in Strapi
2. Check frontend logs: `docker compose logs -f frontend`
3. Should see revalidation for all 3 locales
4. Refresh pages in all languages to verify cache cleared

## Links

- [next-intl Documentation](https://next-intl-docs.vercel.app/)
- [Strapi i18n Plugin](https://docs.strapi.io/user-docs/plugins/strapi-plugins#internationalization-plugin)
- [Next.js Internationalization](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
